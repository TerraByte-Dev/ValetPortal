<%- include('partials/header', { title: 'Compare Valets' }) %>
<section class="page-header">
  <div>
    <p class="eyebrow">Analytics</p>
    <h2>Compare valet performance</h2>
    <p class="muted">Week: <%= formatEstDate(weekStart) %> - <%= formatEstDate(weekDisplayEnd) %> (EST)</p>
  </div>
  <div class="button-row">
    <a
      href="/admin/charts-compare?week_start=<%= previousWeekStartDate %>&location_id=<%= encodeURIComponent(selectedLocation || '') %>&attribute=<%= encodeURIComponent(selectedAttribute) %>&valet_id=<%= encodeURIComponent(selectedValet || 'all') %>"
      class="btn btn-ghost week-arrow"
      aria-label="Previous week"
    >&lt;</a>
    <a
      href="/admin/charts-compare?week_start=<%= nextWeekStartDate %>&location_id=<%= encodeURIComponent(selectedLocation || '') %>&attribute=<%= encodeURIComponent(selectedAttribute) %>&valet_id=<%= encodeURIComponent(selectedValet || 'all') %>"
      class="btn btn-ghost week-arrow"
      aria-label="Next week"
    >&gt;</a>
    <a href="/admin/charts" class="btn btn-ghost">Single Chart</a>
    <a href="/admin" class="btn btn-ghost">Back to Admin</a>
  </div>
</section>

<section class="card chart-card">
  <form action="/admin/charts-compare" method="GET" class="filter-row">
    <input type="hidden" name="week_start" value="<%= selectedWeekStartDate %>">
    <div class="form-group">
      <label for="location_id">Location</label>
      <select name="location_id" id="location_id">
        <option value="">All Locations</option>
        <% locations.forEach(loc => { %>
          <option value="<%= loc.id %>" <%= (selectedLocation == loc.id) ? 'selected' : '' %>><%= loc.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="form-group">
      <label for="attribute">Attribute</label>
      <select name="attribute" id="attribute">
        <option value="hours" <%= (selectedAttribute === 'hours') ? 'selected' : '' %>>Hours</option>
        <option value="online_tips" <%= (selectedAttribute === 'online_tips') ? 'selected' : '' %>>Online Tips</option>
        <option value="cash_tips" <%= (selectedAttribute === 'cash_tips') ? 'selected' : '' %>>Cash Tips</option>
        <option value="total_tips" <%= (selectedAttribute === 'total_tips') ? 'selected' : '' %>>Total Tips</option>
      </select>
    </div>
    <div class="form-group">
      <label for="valet_id">Valet</label>
      <select name="valet_id" id="valet_id">
        <option value="all" <%= (selectedValet === 'all') ? 'selected' : '' %>>All Valets</option>
        <% valets.forEach(v => { %>
          <option value="<%= v.id %>" <%= (selectedValet == v.id) ? 'selected' : '' %>><%= v.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">Apply</button>
    </div>
  </form>

  <div class="chart-canvas-wrap">
    <canvas id="compareChart"></canvas>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = <%- JSON.stringify(labels) %>;
  const datasets = <%- JSON.stringify(datasets) %>;
  const colors = [
    'rgba(79,140,255,0.7)',
    'rgba(31,209,195,0.7)',
    'rgba(255,176,91,0.7)',
    'rgba(224,117,255,0.7)',
    'rgba(255,107,107,0.7)',
    'rgba(142,221,109,0.7)'
  ];

  const ctx = document.getElementById('compareChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: datasets.map((ds, idx) => ({
        label: ds.label,
        data: ds.data,
        backgroundColor: colors[idx % colors.length],
        borderColor: colors[idx % colors.length].replace('0.7', '1'),
        borderWidth: 1,
        borderRadius: 4,
        maxBarThickness: 32
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#e8f0ff'
          }
        }
      },
      scales: {
        x: {
          stacked: false,
          ticks: {
            color: '#e8f0ff',
            maxRotation: 0,
            autoSkip: true,
            autoSkipPadding: 18
          },
          grid: {
            color: 'rgba(232,240,255,0.12)'
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#e8f0ff'
          },
          grid: {
            color: 'rgba(232,240,255,0.12)'
          }
        }
      }
    }
  });
</script>
<%- include('partials/footer') %>
