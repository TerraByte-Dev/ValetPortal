<%- include('partials/header', { title: 'Charts' }) %>
<section class="page-header">
  <div>
    <p class="eyebrow">Analytics</p>
    <h2>Location performance chart</h2>
    <p class="muted">Date labels are displayed in EST.</p>
  </div>
  <div class="button-row">
    <a href="/admin/charts-compare" class="btn btn-ghost">Compare Valets</a>
    <a href="/admin" class="btn btn-ghost">Back to Admin</a>
  </div>
</section>

<section class="card chart-card">
  <form action="/admin/charts" method="GET" class="filter-row">
    <div class="form-group">
      <label for="location_id">Location</label>
      <select name="location_id" id="location_id">
        <option value="">All Locations</option>
        <% locations.forEach(loc => { %>
          <option value="<%= loc.id %>" <%= (selectedLocation == loc.id) ? 'selected' : '' %>><%= loc.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="form-group">
      <label for="attribute">Attribute</label>
      <select name="attribute" id="attribute">
        <option value="hours" <%= (selectedAttribute === 'hours') ? 'selected' : '' %>>Hours</option>
        <option value="online_tips" <%= (selectedAttribute === 'online_tips') ? 'selected' : '' %>>Online Tips</option>
        <option value="cash_tips" <%= (selectedAttribute === 'cash_tips') ? 'selected' : '' %>>Cash Tips</option>
        <option value="total_tips" <%= (selectedAttribute === 'total_tips') ? 'selected' : '' %>>Total Tips</option>
      </select>
    </div>
    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">Apply</button>
    </div>
  </form>

  <div class="chart-canvas-wrap">
    <canvas id="myChart"></canvas>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = <%- JSON.stringify(labels) %>;
  const datasets = <%- JSON.stringify(datasets) %>;

  const ctx = document.getElementById('myChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: datasets.map((ds) => ({
        ...ds,
        borderRadius: 0,
        categoryPercentage: 1.0,
        barPercentage: 1.0,
        maxBarThickness: 44
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#e8f0ff'
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#e8f0ff',
            maxRotation: 0,
            autoSkip: true,
            autoSkipPadding: 18
          },
          grid: {
            color: 'rgba(232,240,255,0.12)'
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#e8f0ff'
          },
          grid: {
            color: 'rgba(232,240,255,0.12)'
          }
        }
      }
    }
  });
</script>
<%- include('partials/footer') %>
