<%- include('partials/header', { title: 'TrevorView' }) %>
<%
  const fmtNum = (val) => {
    const num = Number(val) || 0;
    if (Number.isInteger(num)) return String(num);
    return num.toFixed(2).replace(/\.00$/, '');
  };
  const fmtMoney = (val) => {
    const num = Number(val) || 0;
    const fixed = num % 1 === 0 ? num.toFixed(0) : num.toFixed(2);
    return `$${fixed}`;
  };
  const fmtRange = (start, end) => {
    try {
      const startStr = new Date(start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const endStr = new Date(end).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      return `${startStr} - ${endStr}`;
    } catch (e) {
      return '';
    }
  };
%>
<section class="page-header">
  <div>
    <p class="eyebrow">TrevorView</p>
    <h2>Manager notebook format</h2>
    <p class="muted">Weekly summaries per location with quick totals.</p>
  </div>
  <div class="button-row">
    <a href="/admin" class="btn btn-ghost">Back to Admin</a>
  </div>
</section>

<% if (!groups || groups.length === 0) { %>
  <section class="card empty-state">
    <h3>No reports yet</h3>
    <p class="muted">Submit a shift report to populate TrevorView.</p>
  </section>
<% } %>

<% groups.forEach(group => { %>
  <section class="card trevor-sheet">
    <div class="trevor-sheet-header">
      <div>
        <h3><%= group.location %></h3>
        <p class="muted">Week of <%= fmtRange(group.weekStart, group.weekEnd) %></p>
      </div>
    </div>

    <div class="table-wrap">
      <table class="trevor-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Hours</th>
            <th>Cash</th>
            <th>Online</th>
            <th>Cars</th>
          </tr>
        </thead>
        <tbody>
          <% group.days.forEach(day => { %>
            <tr>
              <td class="trevor-date">
                <div class="trevor-total"><%= day.displayLabel %></div>
                <div class="trevor-subline"><%= day.displayDate %></div>
              </td>
              <td>
                <div class="trevor-total"><%= fmtNum(day.totalHours) %></div>
                <% day.shifts.forEach(shift => { %>
                  <div class="trevor-subline"><%= shift.name %> - <%= fmtNum(shift.hours) %></div>
                <% }) %>
              </td>
              <td>
                <div class="trevor-total"><%= fmtMoney(day.totalCash) %></div>
                <% day.shifts.forEach(shift => { %>
                  <div class="trevor-subline"><%= shift.name %> - <%= fmtMoney(shift.cash) %></div>
                <% }) %>
              </td>
              <td>
                <div class="trevor-total"><%= fmtMoney(day.totalOnline) %></div>
                <% day.shifts.forEach(shift => { %>
                  <div class="trevor-subline"><%= shift.name %> - <%= fmtMoney(shift.online) %></div>
                <% }) %>
              </td>
              <td>
                <div class="trevor-total"><%= fmtNum(day.totalCars) %></div>
                <% day.shifts.forEach(shift => { %>
                  <div class="trevor-subline"><%= shift.name %> - <%= fmtNum(shift.cars) %></div>
                <% }) %>
              </td>
            </tr>
          <% }) %>
          <tr class="trevor-totals-row">
            <td>Totals</td>
            <td><%= fmtNum(group.weeklyTotals.hours) %></td>
            <td><%= fmtMoney(group.weeklyTotals.cash) %></td>
            <td><%= fmtMoney(group.weeklyTotals.online) %></td>
            <td><%= fmtNum(group.weeklyTotals.cars) %></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="trevor-valet-totals">
      <% group.valetTotals.forEach(valet => { %>
        <div class="trevor-valet">
          <strong><%= valet.name %></strong>
          <span class="muted"><%= fmtNum(valet.hours) %> hrs Â· <%= fmtMoney(valet.cash + valet.online) %></span>
        </div>
      <% }) %>
    </div>
  </section>
<% }) %>
<%- include('partials/footer') %>
